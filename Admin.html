<!doctype html>
<html lang="en-us">

<head>
  <meta charset="UTF-8">
  <title>Admin</title>
  <link rel="stylesheet" type="text/css" href="assets/css/reset.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
<!-- ******************* -->
<!-- Styling starts here -->
<!-- *******************-->
    <style>
    @import url(https://fonts.googleapis.com/css?family=Work+Sans:300,600);
    body{
        font-family: 'Work Sans', sans-serif;
        font-size:1.8vmin;
        color: white;
        background: black;
        padding-top:1vh;
        text-decoration: none;
        margin:2vmin; 
        text-align:center;
        cursor: pointer;
    }
    nav{
        font-size: 6vmin;
        background-color: rgba(64,64,64,0.75);
        float:left;    
    }
    img{
        width:100%;
    }
    .col-md-1:hover{
        transform: scale(2.5);
        transform-origin: top;
        z-index: 99;
        position:relative;
    }

    .idText{
        font-size: 1vmin;
        color:gray;
    }
    .col-md-1,
    .col-md-2{
        border:1px solid gray;
        background: black; 
        padding:0;
        width:99%
    }
    #missingName,
    #missingURL {
        display:none;
    }
    </style>
<!-- ***************** -->
<!-- Styling ends here -->
<!-- *****************-->

<!-- ***************** -->
<!--   HTML Body here  -->
<!-- ***************** -->
    <nav class="navbar fixed-top">
        <!-- upper leftside title -->
        <div class="navbar-logo">Admin</div>
    </nav>
    <!-- main body section -->
    <div class='container-fluid' id='mainBody' style="margin-top:10vmin">
        <div class='row' style='background: gray'>
            <div class'col-md-12'>
                <h2 style="padding-left:2.5vmin">Person Group: marvel</h2>
            </div>
        </div>
        <div class='row' id='row1'>
            <div class='col-md-2'>
                <h5>Input new character:</h5>
                <form>
                    <div class="form-group">
                        <label for="personName">Character Name</label>
                        <input type="text" class="form-control" id="personName" placeholder="Enter character name">
                    </div>
                    <div class="form-group">
                        <label for="personImageUrl">Image URL</label>
                        <input type="text" class="form-control" id="personImageUrl" placeholder="Type in URL">
                    </div>
                    <!-- <div class="form-group">
                        <label for="personImageUrl2">2nd Image URL</label>
                        <input type="text" class="form-control" id="personImageUrl2" placeholder="(OPTIONAL)">
                    </div>
                    <div class="form-group">
                        <label for="personImageUrl3">3rd Image URL</label>
                        <input type="text" class="form-control" id="personImageUrl3" placeholder="(OPTIONAL)">
                    </div> -->
                    <button type="submit" class="btn btn-secondary" id="submit">Submit</button>
                    <button type="submit" class="btn btn-success" id="train">Analyze images</button>
                </form>
                <div class="alert alert-warning" id='missingName'>
                    <strong>Info Missing!</strong> Please Type in Character Name.
                </div>
                <div class="alert alert-warning" id='missingURL'>
                    <strong>Info Missing!</strong> Please Type in Image URL.
                </div>
            </div>
        </div>
    </div>

<!-- ***************** -->
<!--  JAVASCRIPT here  -->
<!-- ***************** -->

<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>      

<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBKX1GXX2C_DBhXESSB3xtln6W8czM-TJY",
    authDomain: "project1-marvelfaceapi.firebaseapp.com",
    databaseURL: "https://project1-marvelfaceapi.firebaseio.com",
    projectId: "project1-marvelfaceapi",
    storageBucket: "project1-marvelfaceapi.appspot.com",
    messagingSenderId: "259704712712"
  };
  firebase.initializeApp(config);
  var database = firebase.database();

// INITIALIZE GLOBAL VARIABLES
var apiKey = '10f397a3144b4015b61663d5d274889c';
var personName ='';
var personId ='';
var personImageUrl='';
var persistedFaceId='';
var personImageUrl2='';
var persistedFaceId2='';
var personImageUrl3='';
var persistedFaceId3='';
var colNum = 0;
var personCount=0;
var rowCount = 2

// create initial 10 character columns to be filled (1st 2 columns are reserved for input form)
for (var i=0; i<10;i++){
    $('<div>').addClass('col-md-1').attr('id','col-'+i).appendTo('#row1');
};

// function to add additional rows and columns to grid as needed once existing ones fill up
function addRows() {
    if ((personCount-10)%12 === 0){
        $('<row>').addClass('row').attr('id','row'+rowCount).appendTo('#mainBody');
        for (var i=personCount; i<(personCount+12);i++){
            $('<div>').addClass('col-md-1').attr('id','col-'+i).appendTo('#row'+rowCount);
        };
        rowCount++
    }
};

// fillout database function to be called on new submit and on page load
function fillOutHtmlDataBase(){
    $('<div>').text(personName).appendTo('#col-'+ colNum);
    $('<div>').text(personId).addClass('idText').appendTo('#col-'+ colNum);
    $('<hr>').appendTo('#col-'+ colNum);
    $("<img>").attr("src", personImageUrl).appendTo('#col-'+ colNum);
    $('<div>').text(persistedFaceId).addClass('idText').appendTo('#col-'+ colNum);
    // $('<hr>').appendTo('#col-'+ colNum);
    // $("<img>").attr("src", personImageUrl2).appendTo('#col-'+ colNum);
    // $('<div>').text(persistedFaceId2).addClass('idText').appendTo('#col-'+ colNum);
    // $("<img>").attr("src", personImageUrl3).appendTo('#col-'+ colNum);
    // $('<div>').text(persistedFaceId3).addClass('idText').appendTo('#col-'+ colNum);
    colNum++;
};


database.ref().orderByChild("personName").on("child_added", function(snapshot) {
    console.log('firebase worked');
    personName = snapshot.val().personName;
    personId = snapshot.val().personId;
    personImageUrl = snapshot.val().personImageUrl;
    persistedFaceId= snapshot.val().persistedFaceId;
    personImageUrl2 = snapshot.val().personImageUrl2;
    persistedFaceId2= snapshot.val().persistedFaceId2;
    personImageUrl3 = snapshot.val().personImageUrl3;
    persistedFaceId3= snapshot.val().persistedFaceId3;
    personCount++;
    addRows();
    fillOutHtmlDataBase();
}, function(errorObject) {
    console.log("The read failed: " + errorObject.code);
});


// functions and rest of script below:
$(document).on("click", '#submit', function(event) {
    event.preventDefault();
    $('#missingName').css('display','none');
    $('#missingURL').css('display','none')
    personName = $("#personName").val().trim();
    personImageUrl = $("#personImageUrl").val().trim();
    // personImageUrl2 = $("#personImageUrl2").val().trim();
    // personImageUrl3 = $("#personImageUrl3").val().trim();

    //checks if each input has a value
    if (personName === "") {$('#missingName').css('display','block')};
    if (personImageUrl === "") {$('#missingURL').css('display','block')};
        
    // pushes info to firebase after AJAX calls return Ids. NESTED into AJAX promise of addImage()
    function firebasePush(){
        database.ref().push({
            personName: personName,
            personId: personId,
            personImageUrl: personImageUrl,
            persistedFaceId: persistedFaceId ,
            personImageUrl2: personImageUrl2,
            persistedFaceId2: '',
            personImageUrl3: personImageUrl3,
            persistedFaceId3: '',
        });
        $("#personName").val('');
        $("#personImageUrl").val('');
        $("#personImageUrl2").val('');
        $("#personImageUrl3").val('');
    };    
    
    // second AJAX call to add image to person ID created below (nested in ajax call below)
    function addimage(){      
            $.ajax({
                url: "https://westus.api.cognitive.microsoft.com/face/v1.0/persongroups/marvel/persons/"+personId+"/persistedFaces?",
                beforeSend: function(xhrObj){
                    // Request headers
                    xhrObj.setRequestHeader("Content-Type","application/json");
                    xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key","10f397a3144b4015b61663d5d274889c");
                },
                type: "POST",
                // Request body
                data: JSON.stringify({
                    "url": personImageUrl
                }),
            })
            .done(function(data) {
                // alert("success");
                console.log(data.persistedFaceId);
                persistedFaceId = data.persistedFaceId
                firebasePush();
            })
            .fail(function() {
                console.log("error");
            });
    };
        // first AJAX call - creates person id
          $.ajax({
            url: "https://westus.api.cognitive.microsoft.com/face/v1.0/persongroups/marvel/persons?",
            beforeSend: function(xhrObj){
                // Request headers
                xhrObj.setRequestHeader("Content-Type","application/json");
                xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key","10f397a3144b4015b61663d5d274889c");
            },
            type: "POST",
            // Request body
            data: JSON.stringify({
                "name": personName,
                "userData": "User-provided data attached to the person."
                }),
        })
        .done(function(data) {
            personId = data.personId;
            addimage();
        })
        .fail(function() {
            console.log("error");
        });
});

$(document).on("click", '#train', function(event) {
        event.preventDefault();  
        $.ajax({
            url: "https://westus.api.cognitive.microsoft.com/face/v1.0/persongroups/marvel/train",
            beforeSend: function(xhrObj){
                // Request headers
                xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key","10f397a3144b4015b61663d5d274889c");
            },
            type: "POST",
            // Request body
            data: '',
        })
        .done(function(data) {
            console.log(data);
        })
        .fail(function(error) {
            console.log(error);
        });
   
});
</script>
</body>